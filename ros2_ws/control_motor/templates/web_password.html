<!DOCTYPE html>
<html lang="zh-Hant">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>password input</title>
<link rel="stylesheet" href="{{ url_for('static', filename='motor_style.css') }}">
</head>
<body id="passwordbackground">

<h1 class="g1">
        登入馬達使用介面
</h1>
<div class="login-container">
        <div class="inputall">
                <input id="input1" name="user_id" type="text" placeholder="id卡身分資訊" onclick="RfidInput()"> 
                <input id="input2" name="user_password" type="password" placeholder="請輸入密碼"> 
        </div>
        <div class="loginall">
                <button id="login" type="button" onclick="readpassword()"> 登入 </button>
        </div>
</div>
<script>
console.log("JS START password page");

function readpassword(){
    
    let id =document.getElementById("input1").value;
    let password = document.getElementById("input2").value; //.value是 input 元素的固定屬性
    if (!id || !password) {
        alert("ID 或密碼不可為空！");
        return; // 停止執行
    }
    fetch("/api/password",{                                 //這裡的api/data  data是參數的名稱 是連接flask的路由 自己取的
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ 
            user_id : id ,
            user_password : password
            })
    })
    .then(res => {
        // 檢查 HTTP 狀態碼是否在 200-299 範圍內
        if (!res.ok) {
            throw new Error('伺服器響應錯誤，狀態碼: ' + res.status);
        }
        return res.json(); // 解析後端回傳的 JSON
    })
    .then(data => {
        console.log("後端回傳結果:", data);
        
        // 核心邏輯：判斷後端 JSON 的 status 字段
        if (data.status === "success") {
            // **在 JavaScript 函式中手動執行頁面跳轉**
            window.location.href = data.redirect_url; 
        } else {
            // 驗證失敗，顯示後端回傳的錯誤訊息
            alert("登入失敗: " + data.msg);
        }
    })
    .catch(error => {
        alert("網路或伺服器連線發生錯誤！請查看 Console。");
        console.error('Fetch 錯誤:', error);
    });
}


let lastRfid = null;

function RfidInput() {
  fetch("/api/rfid")
    .then(res => res.json())
    .then(data => {
      console.log("更新 API 回傳：", data);

      if (data.status === "success") {
        if (data.rfid !== lastRfid) {
          document.getElementById("input1").value = data.rfid;
          lastRfid = data.rfid;
          console.log("RFID changed:", data.rfid);
        }
      }
    });
}

setInterval(RfidInput, 2000);
// console.log("JS LOADED on", window.location.pathname);

// setInterval(() => {

//   fetch("/api/maintenance")
//     .then(res => res.json())
//     .then(data => {
//       console.log("API data =", data);
//       console.log("maintenance value =", data.maintenance, typeof data.maintenance);

//       if (data.maintenance === true) {
//         console.log(">>> SHOULD REDIRECT TO /maintain");
//         if (window.location.pathname !== "/maintain") {
//           window.location.href = "/maintain";
//         }
//       }else {
//         // 離開維護頁
//         if (window.location.pathname === "/maintain") {
//           window.location.href = "/";
//         }
//       }
      
//     })
//     .catch(err => console.error("fetch error", err));
// }, 1000);
</script>
<script src="{{ url_for('static', filename='maintenance_guard.js') }}"></script>
</body>