<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>RFID Smart Home Dashboard</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #1e272e;
      color: #f5f6fa;
      margin: 0;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .header h1 {
      margin: 0;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .last-update {
      font-size: 0.85rem;
      color: #dcdde1;
      background: #2f3640;
      padding: 8px 14px;
      border-radius: 8px;
    }
    .last-update .time {
      color: #00a8ff;
      font-weight: 600;
    }
    .card {
      background: #2f3640;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }
    h2 {
      margin-top: 0;
      margin-bottom: 12px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
      margin-bottom: 8px;
      box-sizing: border-box;
    }
    button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: #00a8ff;
      color: white;
    }
    button:hover {
      background: #0091e6;
    }
    button.btn-logout {
      background: #e84118;
    }
    button.btn-logout:hover {
      background: #c23616;
    }
    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .col {
      flex: 1 1 260px;
    }
    .value {
      font-size: 1.4rem;
      font-weight: 600;
    }
    .sub {
      font-size: 0.9rem;
      color: #dcdde1;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      margin-left: 4px;
    }
    .badge-ok {
      background: #2ecc71;
      color: #0b2e13;
    }
    .badge-fail {
      background: #e84118;
      color: #ffe6e1;
    }
    .badge-logout {
      background: #f39c12;
      color: #1e272e;
    }
    .connection-status {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .connection-status.connected {
      background: #2ecc71;
    }
    .connection-status.disconnected {
      background: #e84118;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>RFID Smart Home Dashboard</h1>
    <div class="header-right">
      <div class="last-update">
        <span class="connection-status disconnected" id="connectionStatus"></span>
        ç³»çµ±è³‡æ–™æœ€å¾Œæ›´æ–°: <span class="time" id="lastUpdateTime">-</span>
      </div>
      <button id="btnLogout" class="btn-logout">ç™»å‡º</button>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <div class="card">
        <h2>Sensor</h2>
        <div>Light (Lux): <span id="lux" class="value">-</span></div>
        <div>Temperature (C): <span id="temp" class="value">-</span></div>
        <div>Humidity (%): <span id="hum" class="value">-</span></div>
        <div class="sub" style="margin-top:8px;">
          Sensor æ›´æ–°: <span id="sensorUpdateAgo">-</span>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card">
        <h2>RFID and Auth</h2>
        <div>Last UID: <span id="uid" class="value">-</span></div>
        <div style="margin-top:8px;">
          Auth State:
          <span id="authState">-</span>
          <span id="authBadge" class="badge"></span>
        </div>
        <div style="margin-top:12px;">
          <label for="password">è¼¸å…¥å¯†ç¢¼ï¼ˆèˆ‡å¡ç‰‡ç¶å®šï¼‰</label>
          <input type="text" id="password" placeholder="ä¾‹å¦‚ 1234">
          <button id="btnSendPwd">é€å‡ºå¯†ç¢¼</button>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card">
        <h2>Motor Control</h2>
        <label for="motorSpeed">é¦¬é”é€Ÿåº¦ (0-255)</label>
        <input type="number" id="motorSpeed" min="0" max="255" value="0">
        <button id="btnSetMotor">è¨­å®šé€Ÿåº¦</button>
        <div class="sub" style="margin-top:8px;">æˆæ¬ŠæˆåŠŸå¾Œï¼Œæ‰èƒ½çœŸæ­£æ§åˆ¶é¦¬é”ã€‚</div>
      </div>
    </div>
  </div>

  <script>
    var socket = io("/ws");

    var luxSpan = document.getElementById('lux');
    var tempSpan = document.getElementById('temp');
    var humSpan = document.getElementById('hum');
    var uidSpan = document.getElementById('uid');
    var authStateSpan = document. getElementById('authState');
    var authBadgeSpan = document.getElementById('authBadge');
    var lastUpdateTimeSpan = document.getElementById('lastUpdateTime');
    var sensorUpdateAgoSpan = document.getElementById('sensorUpdateAgo');
    var connectionStatus = document.getElementById('connectionStatus');

    var pwdInput = document.getElementById('password');
    var btnSendPwd = document.getElementById('btnSendPwd');
    var btnLogout = document. getElementById('btnLogout');

    var motorInput = document.getElementById('motorSpeed');
    var btnSetMotor = document.getElementById('btnSetMotor');

    var lastSensorTimestamp = null;
    var lastAnyUpdateTimestamp = null;
    var lastAuthState = null;

    function formatTimestampToClock(ts) {
      if (!ts) return '-';
      var date = new Date(ts * 1000);

      // å–æ™‚åˆ†ç§’ï¼ˆè£œ 0ï¼‰
      var h = String(date.getHours()).padStart(2, '0');
      var m = String(date.getMinutes()).padStart(2, '0');
      var s = String(date.getSeconds()).padStart(2, '0');

      return `${h}:${m}:${s}`;
    }

    // æ¯ç§’æ›´æ–°ç•«é¢ä¸Šçš„æ–‡å­—
    setInterval(function() {
      lastUpdateTimeSpan.textContent  = formatTimestampToClock(lastAnyUpdateTimestamp);
      sensorUpdateAgoSpan.textContent = formatTimestampToClock(lastSensorTimestamp);
    }, 1000);

    socket.on('connect', function() {
      console.log('Connected to WebSocket');
      connectionStatus.classList.remove('disconnected');
      connectionStatus.classList.add('connected');
      lastAnyUpdateTimestamp = Date.now() / 1000;
    });

    socket.on('disconnect', function() {
      console.log('Disconnected from WebSocket');
      connectionStatus.classList.remove('connected');
      connectionStatus.classList.add('disconnected');
    });

    // ====== Sensor æ›´æ–° ======
    socket.on('sensor_update', function(data) {
      console.log('[sensor_update]', Date.now(), data);
      if (data.lux !== undefined)         luxSpan.textContent  = data.lux.toFixed(1);
      if (data.temperature !== undefined) tempSpan.textContent = data.temperature.toFixed(1);
      if (data.humidity !== undefined)    humSpan.textContent  = data.humidity.toFixed(1);

      var ts = data.timestamp || (Date.now() / 1000);
      lastSensorTimestamp  = ts;
      lastAnyUpdateTimestamp = ts;
    });

    // ====== RFID æ›´æ–° ======
    socket.on('rfid_update', function(data) {
      if (data.uid !== undefined) uidSpan.textContent = data.uid || '-';
      var ts = data.timestamp || (Date.now() / 1000);
      lastAnyUpdateTimestamp = ts;
    });

    // ====== Auth æ›´æ–° + å¯†ç¢¼éŒ¯èª¤æç¤º ======
    socket.on('auth_update', function(data) {
      if (!data || data.auth_state === undefined) return;

      var state = data.auth_state;
      var prevState = lastAuthState;
      lastAuthState = state;

      authStateSpan.textContent = state;
      authBadgeSpan.textContent = '';
      authBadgeSpan.className   = 'badge';

      if (state.indexOf('AUTH_OK') === 0) {
        authBadgeSpan.textContent = 'å·²ç™»å…¥';
        authBadgeSpan.classList.add('badge-ok');

      } else if (state.indexOf('AUTH_FAIL') === 0) {
        // åªé‡å° WRONG_PASSWORD è·³æç¤ºï¼Œä¸è¦ NO_UID / UID_NOT_FOUND ä¹Ÿä¸€ç›´åµ
        var isWrongPwd = state.indexOf('WRONG_PASSWORD') !== -1;

        authBadgeSpan.textContent = isWrongPwd ? 'å¯†ç¢¼éŒ¯èª¤' : 'èªè­‰å¤±æ•—';
        authBadgeSpan.classList.add('badge-fail');

        // åªæœ‰å¾ã€Œä¸æ˜¯ FAILã€â†’ã€ŒFAIL ä¸” WRONG_PASSWORDã€çš„é‚£ä¸€ä¸‹æ‰è·³ alert
        if (isWrongPwd && (!prevState || prevState.indexOf('AUTH_FAIL') !== 0)) {
          alert('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡');
          pwdInput.value = '';
          pwdInput.focus();
        }

      } else if (state.indexOf('AUTH_LOGOUT') === 0) {
        authBadgeSpan.textContent = 'å·²ç™»å‡º';
        authBadgeSpan.classList.add('badge-logout');
        uidSpan.textContent = '-';
        pwdInput.value = '';
      }

      var ts = data.timestamp || (Date.now() / 1000);
      lastAnyUpdateTimestamp = ts;
    });

    var lastWrongPwdTs = null;

    // ====== Auth æ›´æ–°ï¼ˆé †ä¾¿æ”¹ UI æ›´ä¹¾æ·¨ï¼‰ ======
    socket.on('auth_update', function(data) {
      if (!data || data.auth_state === undefined) return;

      var state = data.auth_state;
      authStateSpan.textContent = state;

      authBadgeSpan.textContent = '';
      authBadgeSpan.className   = 'badge';

      // é€™æ¬¡äº‹ä»¶çš„æ™‚é–“ï¼ˆä¸ç®¡æ˜¯ heartbeat é‚„æ˜¯æ–°çš„å˜—è©¦ï¼‰
      var ts = data.timestamp || (Date.now() / 1000);

      if (state.indexOf('AUTH_OK') === 0) {
        authBadgeSpan.textContent = 'å·²ç™»å…¥';
        authBadgeSpan.classList.add('badge-ok');

      } else if (state.indexOf('AUTH_FAIL') === 0) {
        var isWrongPwd = state.indexOf('WRONG_PASSWORD') !== -1;

        authBadgeSpan.textContent = isWrongPwd ? 'å¯†ç¢¼éŒ¯èª¤' : 'èªè­‰å¤±æ•—';
        authBadgeSpan.classList.add('badge-fail');

        // ğŸ”” åªè¦æ˜¯ã€Œæ–°çš„éŒ¯èª¤å˜—è©¦ã€ï¼ˆtimestamp ä¸ä¸€æ¨£ï¼‰ï¼Œå°±è·³ä¸€æ¬¡
        if (isWrongPwd && ts !== lastWrongPwdTs) {
          lastWrongPwdTs = ts;
          alert('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡');
          pwdInput.value = '';
          pwdInput.focus();
        }

      } else if (state.indexOf('AUTH_LOGOUT') === 0) {
        authBadgeSpan.textContent = 'å·²ç™»å‡º';
        authBadgeSpan.classList.add('badge-logout');
        uidSpan.textContent = '-';
        pwdInput.value = '';
      }

      lastAnyUpdateTimestamp = ts;
    });



    btnSendPwd. addEventListener('click', function() {
      var pwd = pwdInput. value. trim();
      if (!pwd) return;
      socket. emit('submit_password', { password: pwd });
    });

    pwdInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        btnSendPwd.click();
      }
    });

    btnSetMotor.addEventListener('click', function() {
      var spd = parseInt(motorInput.value, 10);
      if (isNaN(spd)) spd = 0;
      if (spd < 0) spd = 0;
      if (spd > 255) spd = 255;
      motorInput.value = spd;
      socket.emit('set_motor_speed', { speed: spd });
    });

    btnLogout.addEventListener('click', function() {
      if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) return;

      socket.emit('logout');

      // å…ˆåœ¨å‰ç«¯æ¸…ç•«é¢ï¼Œç­‰å¾Œç«¯ auth_update å†åŒæ­¥ä¸€æ¬¡
      uidSpan.textContent = '-';
      pwdInput.value = '';
      authStateSpan.textContent = 'AUTH_LOGOUT,LOCAL';
      authBadgeSpan.textContent = 'å·²ç™»å‡º';
      authBadgeSpan.className = 'badge badge-logout';
    });


  </script>
</body>
</html>